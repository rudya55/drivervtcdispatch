name: Build Android APK/AAB

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Type de build (debug/release)'
        required: false
        default: 'release'
        type: choice
        options:
          - debug
          - release
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'
      - 'capacitor.config.ts'

jobs:
  build:
    name: Build Android Application
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug list Gradle files
        run: |
          echo "Current working dir: $(pwd)"
          echo "Top-level files:" && ls -la
          echo "Looking for Gradle files:"
          find . -type f \( -name "*.gradle*" -o -name "gradle-wrapper.properties" \) -print || true

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build web app (Vite)
        run: npm run build
        env:
          NODE_ENV: production

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Grant Gradle execution permission
        working-directory: android
        run: chmod +x ./gradlew

      - name: Install Android SDK cmdline-tools
        shell: bash
        run: |
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$RUNNER_TEMP"
          curl -sSLo cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install Android SDK packages
        run: sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Configure local.properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          cat android/local.properties

      - name: Decode Keystore
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
            echo "âœ… Keystore dÃ©codÃ© avec succÃ¨s"
          else
            echo "âš ï¸ KEYSTORE_BASE64 non configurÃ©, build sans signature"
          fi

      - name: Create key.properties
        if: github.event_name != 'pull_request'
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ ! -z "$KEYSTORE_PASSWORD" ]; then
            echo "ðŸ” CrÃ©ation du fichier key.properties dans android/..."
            cat > key.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF
            
            echo "âœ… key.properties crÃ©Ã© Ã : $(pwd)/key.properties"
            echo "ðŸ“Š Taille du fichier: $(wc -c < key.properties) bytes"
            
            echo ""
            echo "ðŸ“„ Contenu de key.properties (masquÃ©):"
            sed 's/Password=.*/Password=***MASKED***/g' key.properties
            
            echo ""
            echo "ðŸ” VÃ©rification des chemins de fichiers:"
            if [ -f "key.properties" ]; then
              echo "  âœ… android/key.properties: $(realpath key.properties)"
            else
              echo "  âŒ android/key.properties: MANQUANT"
            fi
            
            if [ -f "app/upload-keystore.jks" ]; then
              echo "  âœ… Keystore: $(realpath app/upload-keystore.jks) ($(ls -lh app/upload-keystore.jks | awk '{print $5}'))"
            else
              echo "  âŒ Keystore: MANQUANT Ã  android/app/upload-keystore.jks"
            fi
          else
            echo "âš ï¸ Secrets de signature non configurÃ©s"
          fi

      - name: Validate Android keystore
        if: github.event.inputs.build_type == 'release' && secrets.KEYSTORE_BASE64 != ''
        working-directory: android/app
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "ðŸ” Validation complÃ¨te de la keystore Android..."
          echo ""
          
          if [ ! -f "upload-keystore.jks" ]; then
            echo "âŒ ERREUR CRITIQUE: Keystore introuvable Ã : $(pwd)/upload-keystore.jks"
            exit 1
          fi
          
          echo "âœ… Keystore trouvÃ©: $(realpath upload-keystore.jks)"
          echo "ðŸ“Š Taille: $(ls -lh upload-keystore.jks | awk '{print $5}')"
          echo ""
          
          if [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "âŒ ERREUR CRITIQUE: Secrets manquants"
            [ -z "$KEYSTORE_PASSWORD" ] && echo "  - KEYSTORE_PASSWORD manquant"
            [ -z "$KEY_ALIAS" ] && echo "  - KEY_ALIAS manquant"
            [ -z "$KEY_PASSWORD" ] && echo "  - KEY_PASSWORD manquant"
            exit 1
          fi
          
          echo "ðŸ” Tentative de validation avec keytool..."
          if keytool -list -v -keystore upload-keystore.jks -alias "$KEY_ALIAS" -storepass "$KEYSTORE_PASSWORD" -keypass "$KEY_PASSWORD" 2>&1; then
            echo ""
            echo "âœ… Keystore VALIDE - Alias '$KEY_ALIAS' trouvÃ© et mots de passe corrects"
          else
            echo ""
            echo "âŒ ERREUR: Validation keystore Ã©chouÃ©e"
            echo "Causes possibles:"
            echo "  1. Mot de passe keystore incorrect (KEYSTORE_PASSWORD)"
            echo "  2. Mot de passe clÃ© incorrect (KEY_PASSWORD)"
            echo "  3. Alias '$KEY_ALIAS' introuvable dans la keystore"
            echo "  4. Keystore corrompue ou format invalide"
            exit 1
          fi

      - name: Debug key.properties location
        run: |
          echo "=== Recherche de key.properties ==="
          find . -name "key.properties" -type f -exec echo "TrouvÃ©: {}" \; -exec cat {} \;
          echo "=== Recherche de upload-keystore.jks ==="
          find . -name "upload-keystore.jks" -type f -exec echo "TrouvÃ©: {}" \; -exec ls -lh {} \;
          echo "=== Structure du rÃ©pertoire android/ ==="
          ls -la android/
          ls -la android/app/ || true

      - name: Build Android APK (Debug)
        if: github.event.inputs.build_type != 'release'
        working-directory: android
        run: |
          ./gradlew assembleDebug --no-daemon --stacktrace --warning-mode all
          echo "âœ… Debug APK built successfully"
          ls -lh app/build/outputs/apk/debug/

      - name: Build Android APK (Release)
        if: github.event_name != 'pull_request'
        working-directory: android
        run: |
          if [ -f "key.properties" ]; then
            echo "ðŸ”‘ Building SIGNED release APK"
            ./gradlew assembleRelease --no-daemon --stacktrace --warning-mode all
            echo "âœ… Signed release APK built successfully"
          else
            echo "âš ï¸ Building UNSIGNED release APK (no key.properties)"
            ./gradlew assembleRelease --no-daemon --stacktrace --warning-mode all
            echo "âš ï¸ Unsigned release APK built"
          fi
          ls -lh app/build/outputs/apk/release/

      - name: Build Android App Bundle (AAB)
        if: github.event_name != 'pull_request'
        working-directory: android
        run: |
          if [ -f "key.properties" ]; then
            echo "ðŸ”‘ Building SIGNED AAB for Play Store"
            ./gradlew bundleRelease --no-daemon --stacktrace --warning-mode all
            echo "âœ… Signed AAB built successfully"
            ls -lh app/build/outputs/bundle/release/
          else
            echo "âš ï¸ Skipping AAB build (no key.properties)"
          fi

      - name: Get APK/AAB Info
        id: apk_info
        working-directory: android
        run: |
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            APK_SIZE=$(du -h app/build/outputs/apk/release/app-release.apk | cut -f1)
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          fi
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            AAB_SIZE=$(du -h app/build/outputs/bundle/release/app-release.aab | cut -f1)
            echo "aab_size=$AAB_SIZE" >> $GITHUB_OUTPUT
          fi

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.sha }}
          path: |
            android/app/build/outputs/apk/**/*.apk
          retention-days: 30

      - name: Upload AAB (Play Store)
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ github.sha }}
          path: |
            android/app/build/outputs/bundle/**/*.aab
          retention-days: 90

      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Android terminÃ© avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Application: VTC Driver Dispatch" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: com.lovable.drivervtcdispatch" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: 1.0.0 (Build 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "android/key.properties" ]; then
            echo "### âœ… APK et AAB signÃ©s (prÃªts pour le Play Store)" >> $GITHUB_STEP_SUMMARY
            echo "- **APK signÃ©**: ${{ steps.apk_info.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
            echo "- **AAB signÃ©**: ${{ steps.apk_info.outputs.aab_size }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ TÃ©lÃ©chargez l'AAB pour le publier sur le Play Store" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ APK non signÃ© (mode test uniquement)" >> $GITHUB_STEP_SUMMARY
            echo "- **APK debug**: ${{ steps.apk_info.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ Configurez les secrets GitHub pour gÃ©nÃ©rer un APK/AAB signÃ©:" >> $GITHUB_STEP_SUMMARY
            echo "- \`KEYSTORE_BASE64\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`KEYSTORE_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`KEY_ALIAS\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`KEY_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **TÃ©lÃ©charger les fichiers** dans l'onglet 'Artifacts' ci-dessus" >> $GITHUB_STEP_SUMMARY
