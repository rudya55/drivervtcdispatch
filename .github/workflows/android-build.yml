name: Build Android APK

on:
  workflow_dispatch: # Permet de lancer le build manuellement
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug list Gradle files
        run: |
          echo "Current working dir: $(pwd)"
          echo "Top-level files:" && ls -la
          echo "Looking for Gradle files:"
          find . -type f \( -name "*.gradle*" -o -name "gradle-wrapper.properties" \) -print || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web app (Vite)
        run: npm run build

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Install Android SDK cmdline-tools
        shell: bash
        run: |
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$RUNNER_TEMP"
          curl -sSLo cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install Android SDK packages
        run: sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Configure local.properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          cat android/local.properties

      - name: Decode Keystore
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
            echo "âœ… Keystore dÃ©codÃ© avec succÃ¨s"
          else
            echo "âš ï¸ KEYSTORE_BASE64 non configurÃ©, build sans signature"
          fi

      - name: Create key.properties
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ ! -z "$KEYSTORE_PASSWORD" ]; then
            cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF
            echo "âœ… key.properties crÃ©Ã©"
          else
            echo "âš ï¸ Secrets de signature non configurÃ©s"
          fi

      - name: Build Android APK (Debug)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Build Android APK (Release - signed)
        working-directory: android
        run: |
          chmod +x ./gradlew
          if [ -f "key.properties" ]; then
            echo "ðŸ”‘ Building signed release APK"
            ./gradlew assembleRelease --no-daemon --stacktrace
          else
            echo "âš ï¸ Building unsigned release APK"
            ./gradlew assembleRelease --no-daemon --stacktrace
          fi

      - name: Upload APKs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            android/app/build/outputs/apk/**/*.apk
            android/app/build/outputs/bundle/**/*.aab

      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Android terminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "android/key.properties" ]; then
            echo "âœ… **APK signÃ©** prÃªt pour le Play Store" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **APK non signÃ©** (secrets manquants)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TÃ©lÃ©chargez l'APK dans l'onglet 'Artifacts' ci-dessus" >> $GITHUB_STEP_SUMMARY
