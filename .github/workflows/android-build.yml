name: Build Android APK

on:
  workflow_dispatch: # Permet de lancer le build manuellement
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          # S'assurer que l'action de cache Gradle recherche les fichiers de dépendances
          # On inclut à la fois des motifs globaux (projets multi-modules) et les chemins
          # spécifiques au sous-dossier `android/` où vivent les fichiers Gradle de Capacitor.
          cache-dependency-path: |
            **/*.gradle*
            **/gradle-wrapper.properties
            buildSrc/**/Versions.kt
            buildSrc/**/Dependencies.kt
            gradle/*.versions.toml
            **/versions.properties
            # Android-specific paths (redundant mais sûr)
            android/**/build.gradle
            android/**/build.gradle.kts
            android/gradle/wrapper/gradle-wrapper.properties
            android/**/settings.gradle
            android/**/settings.gradle.kts
            android/**/gradle.properties
            android/**/**.gradle*

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web app (Vite)
        run: npm run build

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Install Android SDK cmdline-tools
        shell: bash
        run: |
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$RUNNER_TEMP"
          curl -sSLo cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install Android SDK packages
        run: sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Configure local.properties
        run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

      - name: Build Android APK (Debug)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon

      - name: Build Android APK (Release - unsigned)
        working-directory: android
        continue-on-error: true
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon

      - name: Upload APKs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: android/app/build/outputs/apk/**/*.apk
