name: Android Build (APK / AAB)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build:
    name: Build release APK / AAB
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android commandline tools and SDK components
        run: |
          set -e
          SDK_ROOT="$ANDROID_SDK_ROOT"
          mkdir -p "$SDK_ROOT"
          cd "$SDK_ROOT"
          curl -sSLO https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip -d cmdline-tools
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/ || true
          export PATH="$SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          yes | sdkmanager --sdk_root="$SDK_ROOT" --licenses || true
          sdkmanager --sdk_root="$SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      - name: Decode Google services JSON (if provided)
        if: ${{ secrets.GOOGLE_SERVICES_JSON != '' }}
        run: |
          echo 'Decoding google-services.json from secret'
          echo "$GOOGLE_SERVICES_JSON" | base64 --decode > android/app/google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

      - name: Decode Keystore (if provided)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          echo 'Decoding keystore from secret'
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          echo "storeFile=upload-keystore.jks" > android/key.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Install dependencies and build web bundle
        run: |
          npm ci
        working-directory: .

      - name: Build web assets (Vite)
        run: |
          # Inject map + firebase keys at build-time from secrets
          VITE_GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}" \
          VITE_FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY }}" \
          VITE_FIREBASE_AUTH_DOMAIN="${{ secrets.FIREBASE_AUTH_DOMAIN }}" \
          VITE_FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}" \
          VITE_FIREBASE_STORAGE_BUCKET="${{ secrets.FIREBASE_STORAGE_BUCKET }}" \
          VITE_FIREBASE_MESSAGING_SENDER_ID="${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}" \
          VITE_FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}" \
          VITE_FIREBASE_VAPID_KEY="${{ secrets.FIREBASE_VAPID_KEY }}" \
          npm run build

      - name: Sync Capacitor Android
        run: |
          npx cap sync android

      - name: Build Android release
        run: |
          chmod +x android/gradlew
          cd android
          ./gradlew assembleRelease -x lint --no-daemon

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apks
          path: |
            android/app/build/outputs/apk/release/*.apk
            android/app/build/outputs/bundle/release/*.aab
name: Android Release Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-release:
    name: Build Release APK/AAB
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max_old_space_size=4096
      VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build web (Vite)
        run: npm run build

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: r0adkll/setup-android@v2
        with:
          api-level: 33
          build-tools: '33.0.2'
          cmake: 'false'

      - name: Copy web assets to Android (Capacitor)
        run: npx cap sync android

      - name: Configure Android local properties
        run: |
          echo "sdk.dir=${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}" > android/local.properties

      - name: Restore keystore (if provided)
        if: secrets.KEYSTORE_BASE64 != ''
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          echo "storeFile=app/upload-keystore.jks" > android/key.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Add google-services.json (optional)
        if: secrets.GOOGLE_SERVICES_JSON_BASE64 != ''
        run: |
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > android/app/google-services.json
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}

      - name: Build Android release (assembleRelease)
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease -x lint --no-daemon

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            android/app/build/outputs/apk/**
            android/app/build/outputs/bundle/**
name: Build Android APK

on:
  workflow_dispatch: # Permet de lancer le build manuellement
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug list Gradle files
        run: |
          echo "Current working dir: $(pwd)"
          echo "Top-level files:" && ls -la
          echo "Looking for Gradle files:"
          find . -type f \( -name "*.gradle*" -o -name "gradle-wrapper.properties" \) -print || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build web app (Vite)
        run: npm run build

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Install Android SDK cmdline-tools
        shell: bash
        run: |
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$RUNNER_TEMP"
          curl -sSLo cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install Android SDK packages
        run: sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Configure local.properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          cat android/local.properties

      - name: Decode Keystore
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
            echo "âœ… Keystore dÃ©codÃ© avec succÃ¨s"
          else
            echo "âš ï¸ KEYSTORE_BASE64 non configurÃ©, build sans signature"
          fi

      - name: Create key.properties
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ ! -z "$KEYSTORE_PASSWORD" ]; then
            cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF
            echo "âœ… key.properties crÃ©Ã©"
          else
            echo "âš ï¸ Secrets de signature non configurÃ©s"
          fi

      - name: Build Android APK (Debug)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Build Android APK (Release - signed)
        working-directory: android
        run: |
          chmod +x ./gradlew
          if [ -f "key.properties" ]; then
            echo "ðŸ”‘ Building signed release APK"
            ./gradlew assembleRelease --no-daemon --stacktrace
          else
            echo "âš ï¸ Building unsigned release APK"
            ./gradlew assembleRelease --no-daemon --stacktrace
          fi

      - name: Upload APKs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            android/app/build/outputs/apk/**/*.apk
            android/app/build/outputs/bundle/**/*.aab

      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Android terminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "android/key.properties" ]; then
            echo "âœ… **APK signÃ©** prÃªt pour le Play Store" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **APK non signÃ©** (secrets manquants)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TÃ©lÃ©chargez l'APK dans l'onglet 'Artifacts' ci-dessus" >> $GITHUB_STEP_SUMMARY
